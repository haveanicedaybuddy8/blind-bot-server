<!DOCTYPE html>
<html>
<head>
    <title>Chat Assistant</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; background: transparent; }
        
        #chat-container { background: white; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        #chat-box { flex: 1; padding: 20px; overflow-y: auto; background: #f8f9fa; display: flex; flex-direction: column; gap: 12px; }
        
        /* BUBBLES */
        .user { background: #333; color: white; padding: 12px 16px; border-radius: 18px 18px 0 18px; align-self: flex-end; max-width: 80%; }
        .ai { background: #e9ecef; color: #2d3436; padding: 12px 16px; border-radius: 18px 18px 18px 0; align-self: flex-start; max-width: 80%; }
        .chat-img { max-width: 200px; border-radius: 12px; margin-top: 8px; display: block; border: 2px solid rgba(255,255,255,0.3); }

        /* PREVIEW AREA */
        #preview-container { display: flex; gap: 10px; padding: 0 15px; background: white; transition: all 0.2s; }
        .preview-thumb { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; border: 2px solid #ddd; }
        .preview-wrapper { position: relative; margin-top: 10px; }
        .remove-btn { position: absolute; top: -5px; right: -5px; background: red; color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 12px; display: flex; align-items: center; justify-content: center; cursor: pointer; }

        /* NEW: PRODUCT CARD CAROUSEL */
        .product-carousel {
            display: flex; gap: 10px; overflow-x: auto; padding: 10px 0;
            scrollbar-width: none; /* Hide scrollbar Firefox */
        }
        .product-carousel::-webkit-scrollbar { display: none; } /* Hide scrollbar Chrome */
        
        .product-card {
            min-width: 140px; width: 140px;
            background: white; border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden; cursor: pointer;
            transition: transform 0.2s;
            border: 1px solid #eee;
        }
        .product-card:hover { transform: translateY(-3px); border-color: #333; }
        .product-card img { width: 100%; height: 100px; object-fit: cover; }
        .product-card span { display: block; padding: 8px; font-size: 12px; font-weight: 600; text-align: center; color: #333; }

        /* CONTROLS */
        .controls { display: flex; gap: 10px; align-items: flex-end; padding: 15px; border-top: 1px solid #eee; background: white; }
        textarea { flex: 1; padding: 12px 15px; border: 1px solid #e0e0e0; border-radius: 24px; outline: none; resize: none; font-family: inherit; max-height: 120px; font-size: 14px; }
        .btn { height: 42px; border: none; border-radius: 24px; cursor: pointer; font-weight: 600; color: white; background: #333; padding: 0 20px; }
        #upload-label { width: 42px; height: 42px; background: #f1f3f5; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 18px; color: #555; }
        #file-input { display: none; }
        #loader { display: none; text-align: center; font-size: 11px; color: #888; padding: 5px; }
    </style>
</head>
<body>

    <div id="chat-container">
        <div id="header" style="padding:15px; background:#333; color:white; font-weight:600;">Chat Assistant</div>
        <div id="chat-box"></div>
        <div id="loader">Uploading image...</div>
        <div id="preview-container"></div>

        <div class="controls">
            <label id="upload-label" for="file-input">ðŸ“Ž</label>
            <input type="file" id="file-input" accept="image/*" onchange="uploadImage()">
            <textarea id="msg" placeholder="Type a message..." rows="1"></textarea>
            <button id="send-btn" class="btn" onclick="send()">Send</button>
        </div>
    </div>

   <script>
    const urlParams = new URLSearchParams(window.location.search);
    const CLIENT_API_KEY = urlParams.get('apiKey') || "YOUR_FALLBACK_TEST_KEY"; 
    const SERVER_URL = "https://blind-bot-server.onrender.com"; 
    const supabase = window.supabase.createClient("https://iashgsuvdedpdmytdbgw.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlhc2hnc3V2ZGVkcGRteXRkYmd3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0ODMyNDIsImV4cCI6MjA4MDA1OTI0Mn0.nUyhba86frTJDqqAEfZnjF4s_5sTnda7TjIoKDo2wbc");

    let history = []; 
    let stagedImages = []; 

    // Init Logic (Keep your previous init logic here)

    // Upload Logic (Keep your previous uploadImage logic here)
    async function uploadImage() {
        const fileInput = document.getElementById('file-input');
        const file = fileInput.files[0];
        if (!file) return;

        document.getElementById('loader').style.display = 'block';
        const fileName = `uploads/${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.]/g, '')}`;
        await supabase.storage.from('chat-uploads').upload(fileName, file);
        const { data } = supabase.storage.from('chat-uploads').getPublicUrl(fileName);
        
        stagedImages.push(data.publicUrl);
        document.getElementById('preview-container').innerHTML += `<div class="preview-wrapper"><img src="${data.publicUrl}" class="preview-thumb"></div>`;
        document.getElementById('loader').style.display = 'none';
    }

    // Send Logic
    async function send(overrideText = null) {
        const text = overrideText || document.getElementById('msg').value.trim();
        if (!text && stagedImages.length === 0) return;

        const box = document.getElementById('chat-box');
        
        let displayHtml = "";
        stagedImages.forEach(url => displayHtml += `<img src="${url}" class="chat-img">`);
        if (text) displayHtml += `<div>${text}</div>`;
        
        box.innerHTML += `<div class="user">${displayHtml}</div>`;
        
        let backendText = text;
        stagedImages.forEach(url => backendText += ` [IMAGE_URL: ${url}]`);
        history.push({ role: "user", parts: [{ text: backendText }] });

        document.getElementById('msg').value = "";
        stagedImages = []; // Clear staged after sending
        document.getElementById('preview-container').innerHTML = "";
        
        triggerAIResponse();
    }

    async function triggerAIResponse() {
        const box = document.getElementById('chat-box');
        const loader = document.createElement('div'); loader.className='ai'; loader.innerText='...'; loader.id='temp-loader';
        box.appendChild(loader);

        try {
            const response = await fetch(`${SERVER_URL}/chat`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ history, clientApiKey: CLIENT_API_KEY })
            });
            const data = await response.json();
            document.getElementById('temp-loader').remove();

            // 1. Text Reply
            let replyHtml = data.reply.replace(/\[RENDER_URL: (.*?)\]/, (match, url) => {
                return `<img src="${url}" class="chat-img" style="border: 2px solid #28a745;">`;
            });
            
            // 2. PRODUCT CARDS (NEW)
            let cardsHtml = "";
            if (data.product_suggestions && data.product_suggestions.length > 0) {
                cardsHtml = `<div class="product-carousel">`;
                data.product_suggestions.forEach(prod => {
                    // Click sends the product name as a message
                    cardsHtml += `
                    <div class="product-card" onclick="send('${prod.name}')">
                        <img src="${prod.image}">
                        <span>${prod.name}</span>
                    </div>`;
                });
                cardsHtml += `</div>`;
            }

            box.innerHTML += `<div class="ai">${replyHtml}${cardsHtml}</div>`;
            history.push({ role: "model", parts: [{ text: data.reply }] });
            box.scrollTop = box.scrollHeight;

        } catch (err) {
            console.error(err);
        }
    }
   </script>
</body>
</html>