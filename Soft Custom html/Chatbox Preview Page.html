<div style="display: flex; gap: 20px; flex-wrap: wrap; max-width: 1200px; margin: 0 auto;">
  
  <div style="flex: 1; min-width: 300px; background: white; padding: 24px; border-radius: 12px; border: 1px solid #e2e8f0; height: fit-content; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);">
    <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #f1f5f9;">
        <h3 style="margin:0; color:#1e293b; font-size: 18px;">Configuration</h3>
        <p style="color:#64748b; font-size:13px; margin-top: 5px;">
           Updates appear in the preview after saving.
        </p>
    </div>

    <div style="margin-bottom: 16px;">
      <label style="display:block; font-weight:600; font-size:13px; margin-bottom:6px; color:#334155;">Alignment</label>
      <select id="w-align" style="width:100%; padding: 10px; border-radius:6px; border:1px solid #cbd5e1; background: #fff;">
        <option value="right">Bottom Right (Standard)</option>
        <option value="left">Bottom Left</option>
      </select>
    </div>

    <div style="display:flex; gap:10px; margin-bottom: 16px;">
      <div style="flex:1;">
        <label style="display:block; font-weight:600; font-size:13px; margin-bottom:6px; color:#334155;">Side Margin (px)</label>
        <input type="number" id="w-side" value="20" style="width:100%; padding: 10px; border-radius:6px; border:1px solid #cbd5e1;">
      </div>
      <div style="flex:1;">
        <label style="display:block; font-weight:600; font-size:13px; margin-bottom:6px; color:#334155;">Bottom Margin (px)</label>
        <input type="number" id="w-bottom" value="20" style="width:100%; padding: 10px; border-radius:6px; border:1px solid #cbd5e1;">
      </div>
    </div>

    <div style="margin-bottom: 24px;">
      <label style="display:block; font-weight:600; font-size:13px; margin-bottom:6px; color:#334155;">
        Open Height: <span id="height-val" style="font-weight:400; color:#64748b;">600px</span>
      </label>
      <input type="range" id="w-height" min="400" max="800" step="10" value="600" style="width:100%; cursor: pointer;">
    </div>

    <button id="save-widget-btn" style="width:100%; background: #0f172a; color: white; padding: 14px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: background 0.2s;">
      <span>Save & Reload Preview</span>
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"/></svg>
    </button>
  </div>

  <div style="flex: 2; min-width: 320px; height: 700px; border: 2px solid #e2e8f0; border-radius: 12px; position: relative; overflow: hidden; background: #f8fafc; box-shadow: inset 0 0 20px rgba(0,0,0,0.05);" id="preview-area">
    
    <div id="preview-loading" style="position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); display:flex; align-items:center; justify-content:center; z-index: 50; backdrop-filter: blur(2px);">
        <span style="background:white; padding: 10px 20px; border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); font-weight:600; color: #333;">Loading Site...</span>
    </div>

    <iframe id="bg-preview" src="" style="width:100%; height:100%; border:none;" onload="document.getElementById('preview-loading').style.display='none'"></iframe>

  </div>

</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    
    let currentApiKey = null;

    // 1. Initial Load
    const checkUser = setInterval(() => {
        if (window.logged_in_user) {
            clearInterval(checkUser);
            currentApiKey = window.logged_in_user.api_key;
            
            // Load their current settings into the inputs
            loadCurrentSettings(currentApiKey);

            // Load the LIVE preview (Real Bot included)
            refreshPreview();
        }
    }, 500);

    function refreshPreview() {
        if(!currentApiKey) return;
        document.getElementById('preview-loading').style.display = 'flex';
        // We add a timestamp 't' to force the browser to ignore cache and fetch the new position
        const iframeUrl = `https://blind-bot-server.onrender.com/preview/${currentApiKey}?t=${Date.now()}`;
        document.getElementById('bg-preview').src = iframeUrl;
    }

    // 2. Fetch Settings from Server
    async function loadCurrentSettings(apiKey) {
        try {
            const res = await fetch(`https://blind-bot-server.onrender.com/client-config/${apiKey}`);
            const data = await res.json();
            
            // Populate Inputs
            document.getElementById('w-align').value = data.alignment || 'right';
            document.getElementById('w-side').value = data.sideMargin || 20;
            document.getElementById('w-bottom').value = data.bottomMargin || 20;
            document.getElementById('w-height').value = data.height || 600;
            document.getElementById('height-val').innerText = (data.height || 600) + 'px';
            
        } catch (e) { console.error(e); }
    }

    // 3. UI Helper for Range Slider
    document.getElementById('w-height').addEventListener('input', function() {
        document.getElementById('height-val').innerText = this.value + 'px';
    });

    // 4. Save & Reload Logic
    document.getElementById('save-widget-btn').addEventListener('click', async function() {
        const btn = this;
        const originalText = btn.innerHTML;
        btn.innerHTML = "Saving...";
        btn.disabled = true;

        const payload = {
            clientApiKey: window.logged_in_user.api_key,
            alignment: document.getElementById('w-align').value,
            sideMargin: parseInt(document.getElementById('w-side').value),
            bottomMargin: parseInt(document.getElementById('w-bottom').value),
            height: parseInt(document.getElementById('w-height').value)
        };

        try {
            const res = await fetch('https://blind-bot-server.onrender.com/update-widget-settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            if (res.ok) {
                // Success! Reload the iframe to show the new position
                refreshPreview();
            } else {
                alert("❌ Save failed. Please try again.");
            }
        } catch(e) {
            alert("❌ Network Error");
        }
        
        btn.innerHTML = originalText;
        btn.disabled = false;
    });
});
</script>